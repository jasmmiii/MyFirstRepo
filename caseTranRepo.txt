/** VISA_01： Fraud Recoveries - Domestic - Cash Disbursements - Amount */
    @Query("SELECT COALESCE(SUM(COALESCE(cbd.refundAmt, 0) + COALESCE(cbd.cbReturnAmount, 0)), 0) " +
            "FROM CaseTran t " +
            "JOIN CBDetail cbd ON t.fraudTranNo = cbd.fraudTranNo " +
            "WHERE t.countryCode = 'TW' " +
            "AND t.mccCode IN ('6011', '6010') " +
            "AND cbd.createTime BETWEEN :startDate AND :endDate " +
            "AND (COALESCE(cbd.refundAmt, 0) + COALESCE(cbd.cbReturnAmount, 0) >= 0) " +
            "AND c.cardBin IN :cardBins " +
            "AND cbd.workType = '扣款'"
    )
    long sumDomesticCashAmount(
            @Param("startDate") LocalDateTime startDate,
            @Param("endDate") LocalDateTime endDate,
            @Param("cardBins") List<String> cardBins
    );

    /** VISA_02： Fraud Recoveries - Domestic - Payments - Amount */
    @Query("SELECT COALESCE(SUM(COALESCE(cbd.refundAmt, 0) + COALESCE(cbd.cbReturnAmount, 0)), 0) " +
            "FROM CaseTran t " +
            "JOIN CBDetail cbd ON t.fraudTranNo = cbd.fraudTranNo " +
            "WHERE t.countryCode = 'TW' " +
            "AND t.mccCode NOT IN ('6011', '6010') " +
            "AND cbd.createTime BETWEEN :startDate AND :endDate " +
            "AND (COALESCE(cbd.refundAmt, 0) + COALESCE(cbd.cbReturnAmount, 0) >= 0) " +
            "AND c.cardBin IN :cardBins " +
            "AND cbd.workType = '扣款'"
    )
    long sumDomesticPaymentsAmount(
            @Param("startDate") LocalDateTime startDate,
            @Param("endDate") LocalDateTime endDate,
            @Param("cardBins") List<String> cardBins
    );

    /** VISA_03： Fraud Recoveries - International - Cash Disbursements - Amount */
    @Query("SELECT COALESCE(SUM(COALESCE(cbd.refundAmt, 0) + COALESCE(cbd.cbReturnAmount, 0)), 0) " +
            "FROM CaseTran t " +
            "JOIN CBDetail cbd ON t.fraudTranNo = cbd.fraudTranNo " +
            "WHERE (t.countryCode <> 'TW' OR t.countryCode IS NULL) " +
            "AND t.mccCode IN ('6011', '6010') " +
            "AND cbd.createTime BETWEEN :startDate AND :endDate " +
            "AND (COALESCE(cbd.refundAmt, 0) + COALESCE(cbd.cbReturnAmount, 0) >= 0) " +
            "AND c.cardBin IN :cardBins " +
            "AND cbd.workType = '扣款'"
    )
    long sumInternationalCashAmount(
            @Param("startDate") LocalDateTime startDate,
            @Param("endDate") LocalDateTime endDate,
            @Param("cardBins") List<String> cardBins
    );

    /** VISA_04： Fraud Recoveries - International - Payments - Amount */
    @Query("SELECT COALESCE(SUM(COALESCE(cbd.refundAmt, 0) + COALESCE(cbd.cbReturnAmount, 0)), 0) " +
            "FROM CaseTran t " +
            "JOIN CBDetail cbd ON t.fraudTranNo = cbd.fraudTranNo " +
            "WHERE (t.countryCode <> 'TW' OR t.countryCode IS NULL) " +
            "AND t.mccCode NOT IN ('6011', '6010') " +
            "AND cbd.createTime BETWEEN :startDate AND :endDate " +
            "AND (COALESCE(cbd.refundAmt, 0) + COALESCE(cbd.cbReturnAmount, 0) >= 0) " +
            "AND c.cardBin IN :cardBins " +
            "AND cbd.workType = '扣款'"
    )
    long sumInternationalPaymentsAmount(
            @Param("startDate") LocalDateTime startDate,
            @Param("endDate") LocalDateTime endDate,
            @Param("cardBins") List<String> cardBins
    );

    /** VISA_05： Gross Fraud Losses - Number of Accounts ; 同 MASTER Gross Fraud Losses - Accounts */
    @Query("SELECT COUNT(DISTINCT f.cardNo) FROM CB c " +
            "WHERE c.createTime BETWEEN :startDate AND :endDate" +
            " AND c.cardBin IN :cardBins " +
            "AND c.workType = '扣款'"
    )
    long countDistinctCardNoByDateRange(
            @Param("startDate") LocalDateTime startDate,
            @Param("endDate") LocalDateTime endDate,
            @Param("cardBins") List<String> cardBins
    );

    /** VISA_06： Gross Fraud Losses - Number of Recovered Accounts */
    @Query(value = """
    SELECT COUNT(DISTINCT case_no) FROM (
        SELECT SUBSTRING(cbd.cb_no, 1, 13) AS case_no
        FROM CHARGEBACK_DETAIL cbd
        JOIN CHARGEBACK c ON SUBSTRING(cbd.cb_no, 1, 13) = c.case_no
        LEFT JOIN FRAUD_CASE f ON SUBSTRING(cbd.cb_no, 1, 13) = f.CASE_NO
        WHERE cbd.cb_result = 1
          AND cbd.create_time BETWEEN :startDate AND :endDate
          AND c.work_type = N'扣款'
          AND LEFT(c.cardBin) IN (:cardBins)

        UNION ALL

        SELECT ct.case_no
        FROM CASE_TRAN ct
        JOIN FRAUD_CASE f ON ct.CASE_NO = f.CASE_NO
        WHERE (ct.tran_code = '41' OR ct.tran_code = '43')
          AND ct.tran_date BETWEEN :startDate AND :endDate
          AND LEFT(c.cardBin) IN (:cardBins)
    ) AS combined
    """, nativeQuery = true)
    long countRecoveredAccounts(
            @Param("startDate") LocalDateTime startDate,
            @Param("endDate") LocalDateTime endDate,
            @Param("cardBins") List<String> cardBins
    );

    /** VISA_07： Gross Fraud Losses - Domestic- Cash Disbursements - Count */
    @Query("SELECT COUNT(t.fraudTranNo) " +
            "FROM CaseTran t " +
            "JOIN CBDetail cbd ON t.fraudTranNo = cbd.fraudTranNo " +
            "WHERE t.countryCode = 'TW' " +
            "AND t.mccCode IN ('6011', '6010') " +
            "AND cbd.createTime BETWEEN :startDate AND :endDate " +
            "AND c.cardBin IN :cardBins " +
            "AND cbd.workType = '扣款'"
    )
    long countDomesticCashCountTransactions(
            @Param("startDate") LocalDateTime startDate,
            @Param("endDate") LocalDateTime endDate,
            @Param("cardBins") List<String> cardBins
    );

    /** VISA_08： Gross Fraud Losses - Domestic- Cash Disbursements - Volume */
    @Query("SELECT COALESCE(SUM(t.tranAmt), 0) " +
            "FROM CaseTran t " +
            "JOIN CBDetail cbd ON t.fraudTranNo = cbd.fraudTranNo " +
            "WHERE t.countryCode = 'TW' " +
            "AND t.mccCode IN ('6011', '6010') " +
            "AND cbd.createTime BETWEEN :startDate AND :endDate " +
            "AND c.cardBin IN :cardBins " +
            "AND cbd.workType = '扣款'"
    )
    long sumDomesticCashVolume(
            @Param("startDate") LocalDateTime startDate,
            @Param("endDate") LocalDateTime endDate,
            @Param("cardBins") List<String> cardBins
    );

    /** VISA_09: Gross Fraud Losses - Domestic - Payments - Count */
    @Query("SELECT COUNT(t.fraudTranNo) " +
            "FROM CaseTran t " +
            "JOIN CBDetail cbd ON t.fraudTranNo = cbd.fraudTranNo " +
            "WHERE t.countryCode = 'TW' " +
            "AND t.mccCode NOT IN ('6011', '6010') " +
            "AND cbd.createTime BETWEEN :startDate AND :endDate " +
            "AND c.cardBin IN :cardBins " +
            "AND cbd.workType = '扣款'"
    )
    long countDomesticPaymentsCountTransactions(
            @Param("startDate") LocalDateTime startDate,
            @Param("endDate") LocalDateTime endDate,
            @Param("cardBins") List<String> cardBins
    );

    /** VISA_10: Gross Fraud Losses - Domestic - Payments - Volume */
    @Query("SELECT COALESCE(SUM(t.tranAmt), 0) " +
            "FROM CaseTran t " +
            "JOIN CBDetail cbd ON t.fraudTranNo = cbd.fraudTranNo " +
            "WHERE t.countryCode = 'TW' " +
            "AND t.mccCode NOT IN ('6011', '6010') " +
            "AND cbd.createTime BETWEEN :startDate AND :endDate " +
            "AND c.cardBin IN :cardBins " +
            "AND cbd.workType = '扣款'"
    )
    long sumDomesticPaymentsVolume(
            @Param("startDate") LocalDateTime startDate,
            @Param("endDate") LocalDateTime endDate,
            @Param("cardBins") List<String> cardBins
    );

    /** VISA_11： Gross Fraud Losses - International- Cash Disbursements - Count */
    @Query("SELECT COUNT(t.fraudTranNo) " +
            "FROM CaseTran t JOIN CBDetail cbd ON t.fraudTranNo = cbd.fraudTranNo " +
            "WHERE (t.countryCode <> 'TW' OR t.countryCode IS NULL) " +
            "AND t.mccCode IN ('6011', '6010') " +
            "AND cbd.createTime BETWEEN :startDate AND :endDate " +
            "AND c.cardBin IN :cardBins " +
            "AND cbd.workType = '扣款'"
    )
    long countInternationalCashCountTransactions(
            @Param("startDate") LocalDateTime startDate,
            @Param("endDate") LocalDateTime endDate,
            @Param("cardBins") List<String> cardBins
    );

    /** VISA_12： Gross Fraud Losses - International- Cash Disbursements - Volume */
    @Query("SELECT COALESCE(SUM(t.tranAmt), 0) " +
            "FROM CaseTran t " +
            "JOIN CBDetail cbd ON t.fraudTranNo = cbd.fraudTranNo " +
            "WHERE (t.countryCode <> 'TW' OR t.countryCode IS NULL) " +
            "AND t.mccCode IN ('6011', '6010') " +
            "AND cbd.createTime BETWEEN :startDate AND :endDate " +
            "AND c.cardBin IN :cardBins " +
            "AND cbd.workType = '扣款'"
    )
    long sumInternationalCashVolume(
            @Param("startDate") LocalDateTime startDate,
            @Param("endDate") LocalDateTime endDate,
            @Param("cardBins") List<String> cardBins
    );

    /** VISA_13: Gross Fraud Losses - International - Payments - Count */
    @Query("SELECT COUNT(t.fraudTranNo) " +
            "FROM CaseTran t JOIN CBDetail cbd ON t.fraudTranNo = cbd.fraudTranNo " +
            "WHERE (t.countryCode <> 'TW' OR t.countryCode IS NULL) " +
            "AND t.mccCode NOT IN ('6011', '6010') " +
            "AND cbd.createTime BETWEEN :startDate AND :endDate " +
            "AND c.cardBin IN :cardBins " +
            "AND cbd.workType = '扣款'"
    )
    long countInternationalPaymentsCountTransactions(
            @Param("startDate") LocalDateTime startDate,
            @Param("endDate") LocalDateTime endDate,
            @Param("cardBins") List<String> cardBins
    );

    /** VISA_14: Gross Fraud Losses - International - Payments - Volume */
    @Query("SELECT COALESCE(SUM(t.tranAmt), 0) " +
            "FROM CaseTran t " +
            "JOIN CBDetail cbd ON t.fraudTranNo = cbd.fraudTranNo " +
            "WHERE (t.countryCode <> 'TW' OR t.countryCode IS NULL) " +
            "AND t.mccCode NOT IN ('6011', '6010') " +
            "AND cbd.createTime BETWEEN :startDate AND :endDate " +
            "AND c.cardBin IN :cardBins " +
            "AND cbd.workType = '扣款'"
    )
    long sumInternationalPaymentsVolume(
            @Param("startDate") LocalDateTime startDate,
            @Param("endDate") LocalDateTime endDate,
            @Param("cardBins") List<String> cardBins
    );

    /** MASTER Gross Fraud Losses - Balances */
    @Query("SELECT COALESCE(SUM(cbd.tranAmt), 0) " +
            "FROM CB c " +
            "JOIN CBDetail cbd ON c.cbNo = cbd.cbNo " +
            "WHERE c.createTime BETWEEN :startDate AND :endDate " +
            "AND c.cardBin IN :cardBins " +
            "AND c.workType = '扣款'"
    )
    long grossBalances(
            @Param("startDate") LocalDateTime startDate,
            @Param("endDate") LocalDateTime endDate,
            @Param("cardBins") List<String> cardBins
    );

    /** MASTER Recovery of Fraud Losses - Accounts */
    @Query("SELECT COUNT(DISTINCT f.cardNo) " +
            "FROM CB c " +
            "JOIN CBDetail cbd ON c.cbNo = cbd.cbNo " +
            "WHERE cbd.cbResult = TRUE " +
            "AND c.createTime BETWEEN :startDate AND :endDate " +
            "AND c.cardBin IN :cardBins " +
            "AND c.workType = '扣款'"
    )
    long recoveryAccounts(
            @Param("startDate") LocalDateTime startDate,
            @Param("endDate") LocalDateTime endDate,
            @Param("cardBins") List<String> cardBins
    );

    /** MASTER Recovery of Fraud Losses - Balances */
    @Query("SELECT COALESCE(SUM(COALESCE(cbd.refundAmt, 0) + COALESCE(cbd.cbReturnAmount, 0)), 0) " +
            "FROM CB c " +
            "JOIN CBDetail cbd ON c.cbNo = cbd.cbNo " +
            "WHERE cbd.createTime BETWEEN :startDate AND :endDate " +
            "AND (COALESCE(cbd.refundAmt, 0) + COALESCE(cbd.cbReturnAmount, 0) >= 0) " +
            "AND c.cardBin IN :cardBins " +
            "AND c.workType = '扣款'"
    )
    long recoveryBalances(
            @Param("startDate") LocalDateTime startDate,
            @Param("endDate") LocalDateTime endDate,
            @Param("cardBins") List<String> cardBins
    );

------------------------
// 在您的 Repository 介面中

/**
 * 合併查詢 VISA 交易相關統計 (V01-04, V07-14)
 * 使用條件聚合 (Conditional Aggregation) 將 12 次查詢合併為 1 次
 */
@Query("SELECT new com.scsb.cfms.dto.VisaTransactionStatsDto(" +
        // --- Amount (回收金額: refundAmt + cbReturnAmount) ---
        // V01: 國內 + 現金
        "SUM(CASE WHEN t.countryCode = 'TW' AND t.mccCode IN ('6011', '6010') " +
        "         THEN (COALESCE(cbd.refundAmt, 0) + COALESCE(cbd.cbReturnAmount, 0)) ELSE 0L END), " +
        // V02: 國內 + 支付
        "SUM(CASE WHEN t.countryCode = 'TW' AND t.mccCode NOT IN ('6011', '6010') " +
        "         THEN (COALESCE(cbd.refundAmt, 0) + COALESCE(cbd.cbReturnAmount, 0)) ELSE 0L END), " +
        // V03: 國外 + 現金
        "SUM(CASE WHEN (t.countryCode <> 'TW' OR t.countryCode IS NULL) AND t.mccCode IN ('6011', '6010') " +
        "         THEN (COALESCE(cbd.refundAmt, 0) + COALESCE(cbd.cbReturnAmount, 0)) ELSE 0L END), " +
        // V04: 國外 + 支付
        "SUM(CASE WHEN (t.countryCode <> 'TW' OR t.countryCode IS NULL) AND t.mccCode NOT IN ('6011', '6010') " +
        "         THEN (COALESCE(cbd.refundAmt, 0) + COALESCE(cbd.cbReturnAmount, 0)) ELSE 0L END), " +

        // --- Count (筆數: fraudTranNo) ---
        // V07: 國內 + 現金
        "COUNT(CASE WHEN t.countryCode = 'TW' AND t.mccCode IN ('6011', '6010') THEN 1 ELSE NULL END), " +
        // V08: Volume (交易金額: tranAmt) - 國內 + 現金
        "SUM(CASE WHEN t.countryCode = 'TW' AND t.mccCode IN ('6011', '6010') THEN COALESCE(t.tranAmt, 0) ELSE 0L END), " +
        
        // V09: 國內 + 支付 + Count
        "COUNT(CASE WHEN t.countryCode = 'TW' AND t.mccCode NOT IN ('6011', '6010') THEN 1 ELSE NULL END), " +
        // V10: 國內 + 支付 + Volume
        "SUM(CASE WHEN t.countryCode = 'TW' AND t.mccCode NOT IN ('6011', '6010') THEN COALESCE(t.tranAmt, 0) ELSE 0L END), " +
        
        // V11: 國外 + 現金 + Count
        "COUNT(CASE WHEN (t.countryCode <> 'TW' OR t.countryCode IS NULL) AND t.mccCode IN ('6011', '6010') THEN 1 ELSE NULL END), " +
        // V12: 國外 + 現金 + Volume
        "SUM(CASE WHEN (t.countryCode <> 'TW' OR t.countryCode IS NULL) AND t.mccCode IN ('6011', '6010') THEN COALESCE(t.tranAmt, 0) ELSE 0L END), " +
        
        // V13: 國外 + 支付 + Count
        "COUNT(CASE WHEN (t.countryCode <> 'TW' OR t.countryCode IS NULL) AND t.mccCode NOT IN ('6011', '6010') THEN 1 ELSE NULL END), " +
        // V14: 國外 + 支付 + Volume
        "SUM(CASE WHEN (t.countryCode <> 'TW' OR t.countryCode IS NULL) AND t.mccCode NOT IN ('6011', '6010') THEN COALESCE(t.tranAmt, 0) ELSE 0L END) " +

        ") " +
        "FROM CaseTran t " +
        "JOIN CBDetail cbd ON t.fraudTranNo = cbd.fraudTranNo " +
        // 假設需要 JOIN CB 才能拿到 cardBin，請依實際情況調整
        "JOIN CB c ON cbd.cbNo = c.cbNo " + 
        "WHERE cbd.createTime BETWEEN :startDate AND :endDate " +
        "AND c.cardBin IN :cardBins " +
        "AND cbd.workType = '扣款' " +
        // 根據原始查詢，Amount類統計有此條件，但Count/Volume類沒有。
        // 如果要合併，需確認此條件是否適用於全體。若僅適用於Amount，則需移至Amount的CASE WHEN中。
        // 這裡暫時假設為全域條件，如原始 V01-04 所示。
        "AND (COALESCE(cbd.refundAmt, 0) + COALESCE(cbd.cbReturnAmount, 0) >= 0)"
)
VisaTransactionStatsDto getVisaTransactionStats(
        @Param("startDate") LocalDateTime startDate,
        @Param("endDate") LocalDateTime endDate,
        @Param("cardBins") List<String> cardBins
);
